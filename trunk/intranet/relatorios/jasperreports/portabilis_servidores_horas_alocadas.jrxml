<?xml version="1.0" encoding="UTF-8"?>
<jasperReport xmlns="http://jasperreports.sourceforge.net/jasperreports" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:schemaLocation="http://jasperreports.sourceforge.net/jasperreports http://jasperreports.sourceforge.net/xsd/jasperreport.xsd" name="portabilis_servidores_horas_alocadas" language="groovy" pageWidth="595" pageHeight="842" columnWidth="555" leftMargin="20" rightMargin="20" topMargin="20" bottomMargin="20">
	<property name="ireport.zoom" value="1.5"/>
	<property name="ireport.x" value="0"/>
	<property name="ireport.y" value="0"/>
	<parameter name="instituicao" class="java.lang.Integer">
		<defaultValueExpression><![CDATA[new java.lang.Integer(0)]]></defaultValueExpression>
	</parameter>
	<parameter name="escola" class="java.lang.Integer">
		<defaultValueExpression><![CDATA[new java.lang.Integer(0)]]></defaultValueExpression>
	</parameter>
	<parameter name="ano" class="java.lang.Integer">
		<defaultValueExpression><![CDATA[new java.lang.Integer(0)]]></defaultValueExpression>
	</parameter>
	<parameter name="servidor" class="java.lang.String">
		<defaultValueExpression><![CDATA[new java.lang.Integer(0)]]></defaultValueExpression>
	</parameter>
	<queryString>
		<![CDATA[SELECT public.fcn_upper(nm_instituicao) AS nome_instituicao,

       instituicao.cidade AS cidade_instituicao,

       public.fcn_upper(ref_sigla_uf) AS uf_instituicao,

      (SELECT fcn_upper(substring(logradouro.idtlog from 1 for 1)) ||
              lower(substring(logradouro.idtlog, 2))
         FROM public.logradouro,
              cadastro.juridica,
              cadastro.pessoa ps,
              cadastro.endereco_pessoa
        WHERE juridica.idpes = ps.idpes AND
              ps.idpes = endereco_pessoa.idpes AND
              endereco_pessoa.idlog = logradouro.idlog AND
              juridica.idpes = escola.ref_idpes) AS tipo_logradouro,

      (SELECT CASE WHEN $P{escola} = 0 THEN
              instituicao.logradouro
			  ELSE
	             (SELECT logradouro.nome
                    FROM public.logradouro,
                         cadastro.juridica,
                         cadastro.pessoa ps,
                         cadastro.endereco_pessoa
                   WHERE juridica.idpes = ps.idpes AND
                         ps.idpes = endereco_pessoa.idpes AND
                         endereco_pessoa.idlog = logradouro.idlog AND
                         juridica.idpes = escola.ref_idpes)
			  END) AS logradouro,

      (SELECT CASE WHEN $P{escola} = 0 THEN
              instituicao.bairro
			  ELSE
		         (SELECT bairro.nome
                    FROM public.municipio,
                         cadastro.endereco_pessoa,
                         cadastro.juridica,
                         public.bairro
                   WHERE endereco_pessoa.idbai = bairro.idbai AND
						 bairro.idmun = municipio.idmun AND
						 juridica.idpes = endereco_pessoa.idpes AND
						 juridica.idpes = escola.ref_idpes)
			  END) AS bairro,

			(SELECT CASE WHEN $P{escola} = 0 THEN
                 instituicao.cidade
			 ELSE
                   (SELECT municipio.nome
				     FROM public.municipio,
                          cadastro.endereco_pessoa,
                          cadastro.juridica,
                          public.bairro
					WHERE endereco_pessoa.idbai = bairro.idbai AND
						  bairro.idmun = municipio.idmun AND
						  juridica.idpes = endereco_pessoa.idpes AND
                          juridica.idpes = escola.ref_idpes)
		     END)  AS municipio,

      (SELECT CASE WHEN $P{escola} = 0 THEN
                 instituicao.numero
			  ELSE
		         (SELECT COALESCE(endereco_pessoa.numero,0)
                   FROM cadastro.endereco_pessoa,
                        cadastro.juridica
                  WHERE juridica.idpes = endereco_pessoa.idpes AND
                        juridica.idpes = escola.ref_idpes)
		      END) AS numero,


	 (SELECT CASE WHEN $P{escola} = 0 THEN
                 instituicao.ref_sigla_uf
			 ELSE
                (SELECT municipio.sigla_uf
                   FROM public.municipio,
                        cadastro.endereco_pessoa,
                        cadastro.juridica,
                        public.bairro
                  WHERE endereco_pessoa.idbai = bairro.idbai AND
                        bairro.idmun = municipio.idmun AND
                        juridica.idpes = endereco_pessoa.idpes AND
                        juridica.idpes = escola.ref_idpes)
		     END)  AS uf_municipio,


	 (SELECT CASE WHEN $P{escola} = 0 THEN
                  instituicao.ddd_telefone
			 ELSE
		         (SELECT min(fone_pessoa.ddd)
                    FROM cadastro.fone_pessoa,
                         cadastro.juridica
                   WHERE juridica.idpes = fone_pessoa.idpes AND
                         juridica.idpes = escola.ref_idpes)
		     END) AS fone_ddd,


	 (SELECT CASE WHEN $P{escola} = 0 THEN
                  to_char(instituicao.telefone, '9999-9999')
			 ELSE
                 (SELECT min(to_char(fone_pessoa.fone, '9999-9999'))
                    FROM cadastro.fone_pessoa,
                         cadastro.juridica
                   WHERE juridica.idpes = fone_pessoa.idpes AND
                         juridica.idpes = escola.ref_idpes)
		     END) AS fone,

	 (SELECT CASE WHEN $P{escola} = 0 THEN
                  to_char(instituicao.cep, '99999-999')
			 ELSE
                 (SELECT to_char(endereco_pessoa.cep, '99999-999')
                    FROM cadastro.endereco_pessoa,
                         cadastro.juridica
                   WHERE juridica.idpes = endereco_pessoa.idpes AND
                         juridica.idpes = escola.ref_idpes)
		     END) AS cep,

     	 (SELECT CASE WHEN $P{escola} = 0 THEN
                 ''
			     ELSE
                 	(SELECT ps.email
                       FROM cadastro.pessoa ps,
                            cadastro.juridica
                      WHERE juridica.idpes = ps.idpes AND
                            juridica.idpes = escola.ref_idpes)
		         END) AS email,

       to_char(CURRENT_DATE,'dd/mm/yyyy') AS data_atual,

       to_char(current_timestamp, 'HH24:MI:SS') AS hora_atual,

	servidor.cod_servidor as CodServ,
	sa.carga_horaria as CargaHoraLoc,

     (SELECT CASE WHEN $P{escola} = 0 THEN
                 ''
			 ELSE
                 (SELECT pessoa.nome
                    FROM cadastro.pessoa,
                         cadastro.juridica
                   WHERE escola.ref_idpes = juridica.idpes AND
                         juridica.idpes = pessoa.idpes)
		    END) AS nm_escola,

     (SELECT pessoa.nome
                    FROM cadastro.pessoa,
                         cadastro.juridica
                   WHERE escola.ref_idpes = juridica.idpes AND
                         juridica.idpes = pessoa.idpes) AS nm_escola_servidor,
		pessoa.nome,
    	funcao.nm_funcao,
	    	(SELECT CASE WHEN funcionario.ref_cod_funcionario_vinculo = 3 THEN 'Efetivo'
		     WHEN funcionario.ref_cod_funcionario_vinculo = 4 THEN 'Contratado'
		     WHEN funcionario.ref_cod_funcionario_vinculo = 5 THEN 'Comissionado'
		ELSE
		     'Estagiário'
		END) AS situacao,

		(SELECT CASE WHEN funcao.professor = 1 THEN 'Sim'
	       ELSE
                  'Nao'
               END) As Professor,
	funcionario.matricula,
	(SELECT escolaridade.descricao
	   FROM cadastro.escolaridade
	  WHERE escolaridade.idesco = servidor.ref_idesco) as Escolaridade,
	(SELECT deficiencia.nm_deficiencia
	   FROM cadastro.deficiencia
	  WHERE deficiencia.cod_deficiencia = servidor.ref_cod_deficiencia) as Deficiencia,
        servidor.carga_horaria as CargaHorServ,

	(SELECT CASE WHEN sa.periodo = 3 THEN 'Noturno'
		     WHEN sa.periodo = 2 THEN 'Vespertino'
		     WHEN sa.periodo = 1 THEN 'Matutino'
		END) AS Periodo

  FROM pmieducar.servidor_alocacao sa,
       pmieducar.servidor,
       pmieducar.servidor_funcao,
       pmieducar.funcao,
       portal.funcionario,
       cadastro.fisica,
       cadastro.pessoa,
       pmieducar.escola,
       pmieducar.instituicao,
       pmieducar.escola_ano_letivo

 WHERE escola_ano_letivo.ano = $P{ano} AND
       instituicao.cod_instituicao = $P{instituicao} AND
       (SELECT CASE WHEN $P{escola} = 0 THEN
                 sa.ref_cod_escola = escola.cod_escola
               ELSE
                 sa.ref_cod_escola = escola.cod_escola AND
                 escola.cod_escola = $P{escola}
               END) AND
	   sa.ref_cod_servidor = servidor.cod_servidor AND
       instituicao.cod_instituicao = escola.ref_cod_instituicao AND
       servidor.ref_cod_instituicao = instituicao.cod_instituicao AND
       servidor.cod_servidor = funcionario.ref_cod_pessoa_fj AND
       sa.ref_cod_escola = escola.cod_escola AND
       sa.ref_ref_cod_instituicao = servidor.ref_cod_instituicao AND
       pessoa.idpes = fisica.idpes AND
       funcionario.ref_cod_pessoa_fj = fisica.idpes AND
       servidor_funcao.ref_ref_cod_instituicao = servidor.ref_cod_instituicao AND
       servidor_funcao.ref_cod_servidor = servidor.cod_servidor AND
       servidor_funcao.ref_cod_funcao = funcao.cod_funcao AND
       escola_ano_letivo.ref_cod_escola = escola.cod_escola AND
       servidor.ativo = 1

ORDER BY pessoa.nome,nm_escola_servidor]]>
	</queryString>
	<field name="nome_instituicao" class="java.lang.String"/>
	<field name="cidade_instituicao" class="java.lang.String"/>
	<field name="uf_instituicao" class="java.lang.String"/>
	<field name="tipo_logradouro" class="java.lang.String"/>
	<field name="logradouro" class="java.lang.String"/>
	<field name="bairro" class="java.lang.String"/>
	<field name="municipio" class="java.lang.String"/>
	<field name="numero" class="java.math.BigDecimal"/>
	<field name="uf_municipio" class="java.lang.String"/>
	<field name="fone_ddd" class="java.math.BigDecimal"/>
	<field name="fone" class="java.lang.String"/>
	<field name="cep" class="java.lang.String"/>
	<field name="email" class="java.lang.String"/>
	<field name="data_atual" class="java.lang.String"/>
	<field name="hora_atual" class="java.lang.String"/>
	<field name="codserv" class="java.lang.Integer"/>
	<field name="cargahoraloc" class="java.lang.String"/>
	<field name="nm_escola" class="java.lang.String"/>
	<field name="nm_escola_servidor" class="java.lang.String"/>
	<field name="nome" class="java.lang.String"/>
	<field name="nm_funcao" class="java.lang.String"/>
	<field name="situacao" class="java.lang.String"/>
	<field name="professor" class="java.lang.String"/>
	<field name="matricula" class="java.lang.String"/>
	<field name="escolaridade" class="java.lang.String"/>
	<field name="deficiencia" class="java.lang.String"/>
	<field name="cargahorserv" class="java.lang.Double"/>
	<field name="periodo" class="java.lang.String"/>
	<variable name="variable1" class="java.lang.String"/>
	<variable name="variable2" class="java.lang.String"/>
	<group name="Servidor">
		<groupExpression><![CDATA[$F{codserv}]]></groupExpression>
		<groupHeader>
			<band height="21">
				<staticText>
					<reportElement x="188" y="7" width="38" height="13"/>
					<textElement>
						<font size="8" isBold="true"/>
					</textElement>
					<text><![CDATA[Função:]]></text>
				</staticText>
				<textField isStretchWithOverflow="true">
					<reportElement x="43" y="7" width="145" height="13"/>
					<textElement>
						<font size="8"/>
					</textElement>
					<textFieldExpression class="java.lang.String"><![CDATA[$F{nome}]]></textFieldExpression>
				</textField>
				<staticText>
					<reportElement x="0" y="7" width="41" height="13"/>
					<textElement>
						<font size="8" isBold="true"/>
					</textElement>
					<text><![CDATA[Servidor:]]></text>
				</staticText>
				<staticText>
					<reportElement x="323" y="7" width="50" height="13"/>
					<textElement>
						<font size="8" isBold="true"/>
					</textElement>
					<text><![CDATA[Carga Hor.:]]></text>
				</staticText>
				<textField isStretchWithOverflow="true" isBlankWhenNull="false">
					<reportElement x="371" y="7" width="27" height="13"/>
					<textElement>
						<font size="8"/>
					</textElement>
					<textFieldExpression class="java.lang.String"><![CDATA[$F{cargahorserv}]]></textFieldExpression>
				</textField>
				<textField isStretchWithOverflow="true">
					<reportElement x="459" y="7" width="94" height="13"/>
					<textElement>
						<font size="8"/>
					</textElement>
					<textFieldExpression class="java.lang.String"><![CDATA[$F{escolaridade}]]></textFieldExpression>
				</textField>
				<staticText>
					<reportElement x="399" y="7" width="61" height="13"/>
					<textElement>
						<font size="8" isBold="true"/>
					</textElement>
					<text><![CDATA[Escolaridade:]]></text>
				</staticText>
				<textField isStretchWithOverflow="true">
					<reportElement x="227" y="7" width="76" height="13" isPrintWhenDetailOverflows="true"/>
					<textElement>
						<font size="8"/>
					</textElement>
					<textFieldExpression class="java.lang.String"><![CDATA[$F{nm_funcao}]]></textFieldExpression>
				</textField>
			</band>
		</groupHeader>
		<groupFooter>
			<band height="16"/>
		</groupFooter>
	</group>
	<background>
		<band splitType="Stretch"/>
	</background>
	<title>
		<band splitType="Stretch"/>
	</title>
	<pageHeader>
		<band height="173" splitType="Stretch">
			<staticText>
				<reportElement x="126" y="108" width="297" height="16"/>
				<textElement textAlignment="Center">
					<font size="12" isBold="true" isUnderline="false"/>
				</textElement>
				<text><![CDATA[Relação de Horas Alocadas por Servidor]]></text>
			</staticText>
			<staticText>
				<reportElement x="102" y="16" width="278" height="13"/>
				<textElement>
					<font size="8" isBold="true" pdfEncoding="Cp1252" isPdfEmbedded="true"/>
				</textElement>
				<text><![CDATA[SECRETARIA MUNICIPAL DE EDUCAÇÃO E CULTURA]]></text>
			</staticText>
			<textField isBlankWhenNull="true">
				<reportElement x="315" y="64" width="223" height="13" forecolor="#000000"/>
				<textElement>
					<font size="8" isBold="true" isItalic="false"/>
				</textElement>
				<textFieldExpression class="java.lang.String"><![CDATA["E-mail: "+$F{email}]]></textFieldExpression>
			</textField>
			<textField isBlankWhenNull="true">
				<reportElement x="102" y="40" width="278" height="13"/>
				<textElement>
					<font size="8" isBold="true"/>
				</textElement>
				<textFieldExpression class="java.lang.String"><![CDATA["Endereço: "+$F{logradouro}+" "+$F{numero}]]></textFieldExpression>
			</textField>
			<textField isBlankWhenNull="true">
				<reportElement x="102" y="28" width="278" height="13"/>
				<textElement>
					<font size="8" isBold="true"/>
				</textElement>
				<textFieldExpression class="java.lang.String"><![CDATA[$F{nm_escola}]]></textFieldExpression>
			</textField>
			<textField>
				<reportElement x="412" y="4" width="126" height="13"/>
				<textElement>
					<font size="7" isBold="false"/>
				</textElement>
				<textFieldExpression class="java.lang.String"><![CDATA["Emissão: "+$F{data_atual}+" "+$F{hora_atual}]]></textFieldExpression>
			</textField>
			<textField>
				<reportElement x="102" y="4" width="278" height="13"/>
				<textElement>
					<font size="8" isBold="true"/>
				</textElement>
				<textFieldExpression class="java.lang.String"><![CDATA[$F{nome_instituicao}]]></textFieldExpression>
			</textField>
			<textField isBlankWhenNull="true">
				<reportElement x="464" y="52" width="74" height="13"/>
				<textElement>
					<font size="8" isBold="true"/>
				</textElement>
				<textFieldExpression class="java.lang.String"><![CDATA["CEP: "+$F{cep}]]></textFieldExpression>
			</textField>
			<textField isBlankWhenNull="true">
				<reportElement x="358" y="52" width="101" height="13"/>
				<textElement>
					<font size="8" isBold="true"/>
				</textElement>
				<textFieldExpression class="java.lang.String"><![CDATA[$F{municipio}+" - "+$F{uf_municipio}]]></textFieldExpression>
			</textField>
			<image>
				<reportElement x="22" y="4" width="57" height="46"/>
				<imageExpression class="java.lang.String"><![CDATA["imagens/brasao.jpg"]]></imageExpression>
			</image>
			<elementGroup/>
			<elementGroup/>
			<textField>
				<reportElement x="102" y="64" width="201" height="13"/>
				<textElement>
					<font size="8" isBold="true"/>
				</textElement>
				<textFieldExpression class="java.lang.String"><![CDATA["Fone/Fax: ("+$F{fone_ddd}+") "+$F{fone}]]></textFieldExpression>
			</textField>
			<staticText>
				<reportElement x="46" y="157" width="60" height="13"/>
				<textElement>
					<font size="8" isBold="true"/>
				</textElement>
				<text><![CDATA[Período]]></text>
			</staticText>
			<staticText>
				<reportElement x="142" y="157" width="51" height="13"/>
				<textElement>
					<font size="8" isBold="true"/>
				</textElement>
				<text><![CDATA[Carga Hor.]]></text>
			</staticText>
			<staticText>
				<reportElement x="218" y="157" width="100" height="13"/>
				<textElement>
					<font size="8" isBold="true"/>
				</textElement>
				<text><![CDATA[Escola]]></text>
			</staticText>
			<textField isBlankWhenNull="true">
				<reportElement x="102" y="52" width="253" height="13"/>
				<textElement>
					<font size="8" isBold="true"/>
				</textElement>
				<textFieldExpression class="java.lang.String"><![CDATA["Bairro:" +$F{bairro}]]></textFieldExpression>
			</textField>
		</band>
	</pageHeader>
	<columnHeader>
		<band height="2" splitType="Stretch"/>
	</columnHeader>
	<detail>
		<band height="14" splitType="Stretch">
			<textField>
				<reportElement x="220" y="0" width="239" height="13"/>
				<textElement>
					<font size="8"/>
				</textElement>
				<textFieldExpression class="java.lang.String"><![CDATA[$F{nm_escola_servidor}]]></textFieldExpression>
			</textField>
			<textField>
				<reportElement x="46" y="0" width="60" height="13"/>
				<textElement>
					<font size="8"/>
				</textElement>
				<textFieldExpression class="java.lang.String"><![CDATA[$F{periodo}]]></textFieldExpression>
			</textField>
			<textField isBlankWhenNull="false">
				<reportElement x="142" y="0" width="62" height="13"/>
				<textElement>
					<font size="8"/>
				</textElement>
				<textFieldExpression class="java.lang.String"><![CDATA[$F{cargahoraloc}]]></textFieldExpression>
			</textField>
		</band>
	</detail>
	<columnFooter>
		<band height="12" splitType="Stretch"/>
	</columnFooter>
	<pageFooter>
		<band height="17" splitType="Stretch">
			<textField evaluationTime="Report">
				<reportElement x="501" y="2" width="40" height="13"/>
				<textElement>
					<font size="8"/>
				</textElement>
				<textFieldExpression class="java.lang.String"><![CDATA[" " + $V{PAGE_NUMBER}]]></textFieldExpression>
			</textField>
			<textField>
				<reportElement x="421" y="2" width="80" height="13"/>
				<textElement textAlignment="Right">
					<font size="8"/>
				</textElement>
				<textFieldExpression class="java.lang.String"><![CDATA["Page "+$V{PAGE_NUMBER}+" of"]]></textFieldExpression>
			</textField>
		</band>
	</pageFooter>
	<summary>
		<band height="17" splitType="Stretch"/>
	</summary>
</jasperReport>
